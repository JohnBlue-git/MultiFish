version: '3.8'

services:
  multifish:
    build:
      context: .
      dockerfile: Dockerfile
    image: multifish:latest
    container_name: multifish
    restart: unless-stopped
    
    # Environment variables (can override config file)
    environment:
      - PORT=8080
      - LOG_LEVEL=info
      - WORKER_POOL_SIZE=100
      - LOGS_DIR=/app/logs
      # Authentication (optional)
      # - AUTH_ENABLED=true
      # - AUTH_MODE=token
      # - TOKEN_AUTH_TOKENS=your-token-here
      # Rate limiting (optional)
      # - RATE_LIMIT_ENABLED=true
      # - RATE_LIMIT_RATE=100.0
      # - RATE_LIMIT_BURST=200
    
    # Port mapping
    ports:
      - "8080:8080"
    
    # Volumes
    volumes:
      # Logs directory (persistent)
      - ./logs:/app/logs
      # Configuration file (optional, read-only)
      - ./config.yaml:/app/config.yaml:ro
    
    # Command with config file
    # Remove or modify if you want to use environment variables only
    command: ./multifish -config /app/config.yaml
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/MultiFish/v1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
